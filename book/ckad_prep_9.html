<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Deployments - üçé SRE Journey</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> üõ∂ Introduction</a></li><li class="chapter-item expanded "><a href="becoming_sre.html"><strong aria-hidden="true">2.</strong> üìö Becoming SRE</a></li><li class="chapter-item expanded "><a href="k8s.html"><strong aria-hidden="true">3.</strong> ‚õµÔ∏è k8s</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ckad_prep.html"><strong aria-hidden="true">3.1.</strong> üìú CKAD prep</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ckad_prep_1.html"><strong aria-hidden="true">3.1.1.</strong> üêøÔ∏è k8s in a Nutshell</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ckad_prep_2.html"><strong aria-hidden="true">3.1.1.1.</strong> Object Management</a></li></ol></li><li class="chapter-item expanded "><a href="ckad_prep_first_mod.html"><strong aria-hidden="true">3.1.2.</strong> üêî Application Design and Build</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ckad_prep_3.html"><strong aria-hidden="true">3.1.2.1.</strong> Container Images</a></li><li class="chapter-item expanded "><a href="ckad_prep_4.html"><strong aria-hidden="true">3.1.2.2.</strong> Pods</a></li><li class="chapter-item expanded "><a href="ckad_prep_5.html"><strong aria-hidden="true">3.1.2.3.</strong> Jobs and CronJobs</a></li><li class="chapter-item expanded "><a href="ckad_prep_6.html"><strong aria-hidden="true">3.1.2.4.</strong> Container Storage</a></li><li class="chapter-item expanded "><a href="ckad_prep_7.html"><strong aria-hidden="true">3.1.2.5.</strong> Multi-Container Pods</a></li><li class="chapter-item expanded "><a href="ckad_prep_8.html"><strong aria-hidden="true">3.1.2.6.</strong> Labels and Annotations</a></li></ol></li><li class="chapter-item expanded "><a href="ckad_prep_second_mod.html"><strong aria-hidden="true">3.1.3.</strong> üê¶ Application Deployment</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="ckad_prep_9.html" class="active"><strong aria-hidden="true">3.1.3.1.</strong> Deployments</a></li><li class="chapter-item expanded "><a href="ckad_prep_10.html"><strong aria-hidden="true">3.1.3.2.</strong> Helm</a></li></ol></li><li class="chapter-item expanded "><a href="ckad_prep_third_mod.html"><strong aria-hidden="true">3.1.4.</strong> üê§ Application Observability & Maintenance</a></li><li class="chapter-item expanded "><a href="ckad_focus.html"><strong aria-hidden="true">3.1.5.</strong> üî¨ Where to Focus</a></li></ol></li><li class="chapter-item expanded "><a href="k8s_up_and_running.html"><strong aria-hidden="true">3.2.</strong> üêã k8s up and running</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="k8s_up_and_running_1.html"><strong aria-hidden="true">3.2.1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="k8s_up_and_running_2.html"><strong aria-hidden="true">3.2.2.</strong> Deploying a k8s cluster</a></li><li class="chapter-item expanded "><a href="k8s_up_and_running_3.html"><strong aria-hidden="true">3.2.3.</strong> Common kubectl commands</a></li><li class="chapter-item expanded "><a href="k8s_up_and_running_4.html"><strong aria-hidden="true">3.2.4.</strong> Pods</a></li><li class="chapter-item expanded "><a href="k8s_up_and_running_5.html"><strong aria-hidden="true">3.2.5.</strong> Labels</a></li><li class="chapter-item expanded "><a href="k8s_up_and_running_6.html"><strong aria-hidden="true">3.2.6.</strong> Services</a></li><li class="chapter-item expanded "><a href="k8s_up_and_running_13.html"><strong aria-hidden="true">3.2.7.</strong> ConfigMap and Secrets</a></li></ol></li><li class="chapter-item expanded "><a href="k8s_cheatsheet.html"><strong aria-hidden="true">3.3.</strong> üìù k8s cheatsheet</a></li><li class="chapter-item expanded "><a href="helm.html"><strong aria-hidden="true">3.4.</strong> ‚éà helm</a></li></ol></li><li class="chapter-item expanded "><a href="fluentd.html"><strong aria-hidden="true">4.</strong> ü¶ú Fluentd</a></li><li class="chapter-item expanded "><a href="elk_stack.html"><strong aria-hidden="true">5.</strong> üìà ELK Stack</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">üçé SRE Journey</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="deployments"><a class="header" href="#deployments">Deployments</a></h1>
<p>Managing a set of pods with the same config (called replicas) we want to make
sure we have the same config for these replicas.</p>
<p>We can scale up or down the number of replicas to fulfill our reqs. Updates to
a replica config can be easily rolled out automatically.</p>
<p>Under the hood, we say</p>
<ul>
<li><code>deployment</code>, "create 3 replicas"</li>
<li><code>ReplicaSet</code>, "maintain stable set of 3 pods"</li>
<li><code>pod</code>, "3 pods with the same definition"</li>
</ul>
<p>How do we create them imperatively:</p>
<pre><code class="language-bash">k create deployment my-deploy --image=nginx --replicas=3
</code></pre>
<p>The default <code>--replicas</code> is 1</p>
<p>The yaml would look like this:</p>
<pre><code class="language-yaml">apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  labels:
    app: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.2
        ports:
        - containerPort: 80
</code></pre>
<p>Everything under the <code>spec.template</code> is the same as the attributes for the pod
spec.</p>
<p>The deployment internally uses label selector <code>spec.selector.matchLabels</code>, it
matches against <code>spec.template.metadata.labels</code>.</p>
<h2 id="rolling-out-changes"><a class="header" href="#rolling-out-changes">Rolling out changes.</a></h2>
<p>If you change the live object of the deployment, it will roll out the changes
of the <code>replicasets</code> by themselves.</p>
<p>It will keep a track of the changes, you can check it with:</p>
<pre><code class="language-bash">$ k rollout history deployment my-deploy
</code></pre>
<p>If we make a change to the deployment, for example assign a new image.</p>
<pre><code class="language-bas">k set image deployment my-deploy nginx=nginx:1.19.2
</code></pre>
<p>If you run the <code>k rollout history</code> command again, you will see the new
deployment.</p>
<p>If we want to come back to other versions, we can do</p>
<pre><code class="language-bash">k rollout undo deployment my-deploy --to-revision=1
</code></pre>
<p>You can annotate what changed on each revision</p>
<pre><code>k annotate deployment my-deploy kubernetes.io/change-cause="image updated to 1.17.1"
</code></pre>
<p>This will be displayed when listing the revisions.</p>
<h2 id="manually-scaling-a-deployment"><a class="header" href="#manually-scaling-a-deployment">Manually Scaling a Deployment</a></h2>
<pre><code class="language-bash">k scale deployment my-deploy --replicas=5
</code></pre>
<p>Or we can edit the live object of the deployment.</p>
<h2 id="autoscaling-a-deployment"><a class="header" href="#autoscaling-a-deployment">Autoscaling a Deployment</a></h2>
<p>The deployments scale automatically based on the metrics k8s is generating.</p>
<p>There are a couple of types of autoscalers (which are k8s objects):</p>
<ul>
<li>Horizontal Pod Autoscaler (HPA): standard feature of k8s that scales the
number of pod replicas based on cpu and memory thresholds.
(Relevant for the exam)</li>
<li>Vertical Pod Autoscaler (VPA): scales cpu and memory alloc for existing pods
based on historic metrics. Supported by a cloud provider as an add-on.</li>
</ul>
<p>Both of them use the metrics server. You need to install the component, and set
the resource requests and limits.</p>
<pre><code class="language-yaml">apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: php-apache
spec:
  scaleTargetRef: # the scaling target
    apiVersion: apps/v1
    kind: Deployment
    name: php-apache
  minReplicas: 3
  maxReplicas: 5
  metrics:
  - type: Resource # the thresholds
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 80
</code></pre>
<p>You can see them with <code>k get hpa</code></p>
<h2 id="deployment-strategies"><a class="header" href="#deployment-strategies">Deployment Strategies</a></h2>
<ul>
<li>
<p>ramped: we will touch one replica at a time and update the config needed.</p>
<ul>
<li>pros: leads to no downtime. We roll out the new version to all the replicas
overtime.</li>
<li>cons: make sure we do not introduce breaking changes</li>
</ul>
</li>
<li>
<p>recreate: terminate the old version and then create a new one with the new
config</p>
<ul>
<li>pros: good for dev envs, everything shutdowns at once and renewed at once</li>
<li>cons: can cause downtime</li>
</ul>
</li>
<li>
<p>blue/green: creates a new deployment with the new version, they run along
side each other, and once we are happy with the new one, we switch traffic.
(you need to set up two different deployments)</p>
<ul>
<li>pros: no downtime, traffic can be routed when ready</li>
<li>cons: resource duplication, config and network routing.</li>
</ul>
</li>
</ul>
<blockquote>
<p>Special note on this one. When you have the two deployments, you'll need a
svc that is the one that actually exposes the app, then you can just change
the label selector there from blue to green (or viceversa) and k8s will do
the rest for you</p>
</blockquote>
<ul>
<li>canary: release a new version to a subset of users, then proceed to a full
roll out (useful for testing) (you need to set up two different deployments)
<ul>
<li>pros: new version released to subset of users.</li>
<li>cons: may require a load balancer for fine-grained dist</li>
</ul>
</li>
</ul>
<h3 id="how-do-we-implement-this"><a class="header" href="#how-do-we-implement-this">How do we implement this?</a></h3>
<p><code>under spec.strategy.type</code> we define the type we want. We can configure it
there</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="ckad_prep_second_mod.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="ckad_prep_10.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="ckad_prep_second_mod.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="ckad_prep_10.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
