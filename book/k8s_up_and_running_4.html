<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Pods - üçé SRE Journey</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="introduction.html"><strong aria-hidden="true">1.</strong> üõ∂ Introduction</a></li><li class="chapter-item expanded "><a href="becoming_sre.html"><strong aria-hidden="true">2.</strong> üìö Becoming SRE</a></li><li class="chapter-item expanded "><a href="k8s.html"><strong aria-hidden="true">3.</strong> ‚õµÔ∏è k8s</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="k8s_up_and_running.html"><strong aria-hidden="true">3.1.</strong> üêã k8s up and running</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="k8s_up_and_running_1.html"><strong aria-hidden="true">3.1.1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="k8s_up_and_running_2.html"><strong aria-hidden="true">3.1.2.</strong> Deploying a k8s cluster</a></li><li class="chapter-item expanded "><a href="k8s_up_and_running_3.html"><strong aria-hidden="true">3.1.3.</strong> Common kubectl commands</a></li><li class="chapter-item expanded "><a href="k8s_up_and_running_4.html" class="active"><strong aria-hidden="true">3.1.4.</strong> Pods</a></li><li class="chapter-item expanded "><a href="k8s_up_and_running_5.html"><strong aria-hidden="true">3.1.5.</strong> Labels</a></li><li class="chapter-item expanded "><a href="k8s_up_and_running_6.html"><strong aria-hidden="true">3.1.6.</strong> Services</a></li></ol></li><li class="chapter-item expanded "><a href="k8s_cheatsheet.html"><strong aria-hidden="true">3.2.</strong> üìù k8s cheatsheet</a></li><li class="chapter-item expanded "><a href="helm.html"><strong aria-hidden="true">3.3.</strong> ‚éà helm</a></li></ol></li><li class="chapter-item expanded "><a href="fluentd.html"><strong aria-hidden="true">4.</strong> ü¶ú Fluentd</a></li><li class="chapter-item expanded "><a href="elk_stack.html"><strong aria-hidden="true">5.</strong> üìà ELK Stack</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">üçé SRE Journey</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="pods"><a class="header" href="#pods">Pods</a></h1>
<p>K8s groups multiple containers into a single atomic unit called a <em>pod</em> (This
also goes with the docker theme, since a group of whales is a pod lol)</p>
<p>A pod is a collection of app containers and volumes running in the same
environment. Containers in a pod always land in the same machine.</p>
<p>Apps running in the same pod share, ip addresses and port, hostname, and can
communicate to each other using interprocess communication channels. Meaning
they share:</p>
<ul>
<li>network namespace</li>
<li>UTS namespace</li>
<li>IPC namespace</li>
</ul>
<h2 id="thinking-in-pods"><a class="header" href="#thinking-in-pods">Thinking in Pods</a></h2>
<p><em>What should go in a Pod?</em> To answer this question you go look at your
different containers and ask <em>"Will these containers work correctly if they
land on different machines?"</em> If no, then a pod is the correct way of grouping
them. If yes, you can use multiple pods.</p>
<p>An example, say you want to deploy a wordpress app with a mysql database. Would
you put them in the same pod? I already read the book so I know the answer is
no, but why?</p>
<p>The answer is no because both of those services do not need to scale together.
The wordpress app itself is stateless, so you can create more wordpress pods if
you are scaling. On the other hand a mysql database is much different to scale,
it can be trickier, and you are likely to increase the resources dedicated to a
single mysql pod.</p>
<h2 id="the-pod-manifest"><a class="header" href="#the-pod-manifest">The Pod Manifest</a></h2>
<p>Pods are describe in a <em>manifest</em> which is a text-file representation of the
k8s API object.</p>
<p>As you might remember from the fist chapter, k8s uses a <em>declarative
configuration</em>, which basically means that you tell k8s your ideal state of the
world and it will take action to ensure the state becomes a reality.</p>
<p>When you send a manifest to k8s, it will accept it and process it before
storing it in persistent storage <code>(etcd)</code>. The <em>scheduler</em> will find pods that
have not been assigned to a node, and will place the pods onto those nodes
depending on the resources and constrains you specified in your manifest. K8s
will try to ensure pods from the same app are in different machines for
reliability.</p>
<p>You can see the pods with</p>
<pre><code class="language-bash">k get pods
</code></pre>
<p>You can delete a pod with</p>
<pre><code class="language-bash">k delete pods/&lt;name&gt;
</code></pre>
<h3 id="creating-a-manifest"><a class="header" href="#creating-a-manifest">Creating a manifest</a></h3>
<p>Pod manifest should be treated in the same way a source code, adding comments
to help explain the pod to new team members and stuff like that.</p>
<p>The manifests include a couple of key fields and attributes,</p>
<ul>
<li><code>metadata</code>:
<ul>
<li><code>name</code>: a unique identifier for the deployment</li>
<li><code>namespace</code>: the Kubernetes namespace where the deployment will live</li>
<li><code>labels</code>: key-value pairs that can be used to filter and categorize objects</li>
</ul>
</li>
<li><code>spec</code>:
<ul>
<li><code>containers</code>:
<ul>
<li><code>name</code>: a unique identifier for the container</li>
<li><code>image</code>: the Docker image to use for this container</li>
<li><code>command</code>: the default command to run in the container</li>
<li><code>args</code>: any additional arguments to pass to the command</li>
<li><code>volumeMounts</code>: mounts for persistent storage or other files</li>
</ul>
</li>
<li>volumes:
<ul>
<li><code>name</code>: a unique identifier for the volume</li>
<li><code>persistentVolumeClaim</code>: claims a Persistent Volume resource</li>
</ul>
</li>
</ul>
</li>
<li><code>selectors</code>: used to filter which pods are included in this deployment</li>
</ul>
<p>Example</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: "2024-04-29T20:02:16Z"
  generateName: coredns-76f75df574-
  labels:
    k8s-app: kube-dns
    pod-template-hash: 76f75df574
  name: coredns-76f75df574-k97nj
  namespace: kube-system
  # more stuff
  uid: 4dd80223-de4c-49d7-b407-31908ae96b9e
spec:
  # more stuff
  containers:
  - args:
    - -conf
    - /etc/coredns/Corefile
    image: registry.k8s.io/coredns/coredns:v1.11.1
    imagePullPolicy: IfNotPresent
    # more stuff

    volumeMounts:
    - mountPath: /etc/coredns
      name: config-volume
      readOnly: true
    # more stuff

  volumes:
  - configMap:
      defaultMode: 420
      items:
      - key: Corefile
        path: Corefile
      name: coredns
      # more stuff

status:
  conditions:
  - lastProbeTime: null
    lastTransitionTime: "2024-04-29T20:02:19Z"
    status: "True"
    type: PodReadyToStartContainers
  - lastProbeTime: null
  # more stuff
</code></pre>
<p>You can create a pod from them by using <code>k apply -f manifest.yaml</code> as seen in
previous sections.</p>
<h2 id="some-useful-commands"><a class="header" href="#some-useful-commands">Some Useful Commands</a></h2>
<pre><code class="language-bash"># get info
k get pods  # list pods
k describe pods &lt;podname&gt; # more info on the k8s object

# manipulate pods
k delete pods/&lt;podname&gt; # delete pod, all info associated to it will be deleted
k logs &lt;podname&gt; # check logs
k exec &lt;podname&gt; -- date # run date command inside pod
k exec -it &lt;podname&gt; -- bash # interactive tty
k cp # keep in mind that copying files into a container is an antipattern.
</code></pre>
<h2 id="health-checks"><a class="header" href="#health-checks">Health Checks</a></h2>
<p>When you are running an app in k8s, it is automatically kept alive by a process
health check. This ensure that the app is always running, if it is not it k8s
will restart it.</p>
<p>Sometimes, checking if the process is alive is not enough, maybe it was left
hanging or something like that. K8s has something to check application
<em>liveness</em> and other stuff for your app.</p>
<p>There are different kinds of probes here are some:</p>
<ul>
<li>
<p><strong>Liveness Probe</strong>
This will check app specific stuff, for example checking if http is
returning 200.</p>
<p>While the default response to a failed liveness is to restart you can
change what happened with <code>restartPolicy</code></p>
<p>Here is an example of a <code>livenessProbe</code></p>
<pre><code>spec:
  containers:
  - name: my-container
    image: my-image:latest
    livenessProbe:
      httpGet:
        path: /healthz
        port: 80
        scheme: HTTP
        initialDelaySeconds: 30
        timeoutSeconds: 5
</code></pre>
</li>
<li>
<p><strong>Readiness Probe</strong>
These probes check if an app is ready to serve user requests. Apps that
fail are removed from the load balancers</p>
</li>
<li>
<p><strong>Startup Probe</strong>
Enables you to poll slowly from a slow-starting container, while also
enabling  responsive liveness checks once the container has initialized</p>
</li>
</ul>
<h2 id="resource-management"><a class="header" href="#resource-management">Resource Management</a></h2>
<p>K8s allow you to increase the overall utilization of the machines that are in
the cluster.</p>
<p>Utilization is defined as the amount of resource actively being used divided by
the amount of a resource that has been purchased</p>
<p>Example, if you purchase a one-core machine, and your app uses one tenth of a
core, then your utilization is 10%</p>
<p>You can tell k8s the upper limit and lower limit of resources you want for an
specific container. Keep in mind that this is on a per-container basis, the
whole pod will the sum of the containers.</p>
<p>You can do this by setting up <code>resources</code> in the manifest. The lower limit is
<code>requests</code> and the upper limit is <code>limits</code>.</p>
<pre><code class="language-yaml">spec:
    containers:
    - image: blabla:latest
      name: jose
      resouces:
        cpu: "500m"
        memory: "128Mi"
      limit:
        cpu: "1000m"
        memory: "256Mi"
    # more stuff
</code></pre>
<h2 id="persisting-data-with-volumes"><a class="header" href="#persisting-data-with-volumes">Persisting Data with Volumes</a></h2>
<p>When a container restarts, any data in it will also be deleted. Which is good
since we do not want to leave around cruft.</p>
<p>We can still add volumes to our pods though, that will persist this deletion</p>
<p>In order to do this, you need to two things to the manifest <code>spec.volumes</code>,
which is an array of all volumes that the pod will need.</p>
<p>And the other is <code>volumeMount</code> which specify inside the container definition
the file system to use.</p>
<p>So basically one is like, what volumes will the whole pod use, and the other is
specific to each container.</p>
<pre><code class="language-yaml">spec:
  containers:
  - name: my-container
    image: busybox:latest
    volumeMounts:
    - name: my-filesystem
      mountPath: /mnt
      subPath: data
  volumes:
  - name: my-filesystem
    persistentVolumeClaim:
      claimName: my-pvc
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="k8s_up_and_running_3.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="k8s_up_and_running_5.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="k8s_up_and_running_3.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="k8s_up_and_running_5.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
